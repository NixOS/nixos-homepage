---

import { getEntry } from 'astro:content';

import CodeBlock from "../../../layout/CodeBlock.astro";
import CodeInline from "../../../layout/CodeInline.astro";
import Button from "../../../ui/Button.astro";

const amis = await getEntry('download', 'aws-ec2');

---

<script>
  const awsSelection = document.querySelector(".select-region");
  const awsUrl = "https://console.aws.amazon.com/ec2/home"

  function updateAwsLaunch(region, ami) {
    document
      .querySelector(".launch-aws")
      .setAttribute("href", awsUrl + "?region=" + region + "#launchAmi=" + ami);
  }

  // Display the current AMI and set correct Launch link.
  // Need if page is soft reloaded.
  function setupAwsLaunch() {
    const region = awsSelection.value;
    const ami = document.querySelector("#launch-amazon-" + region);
    ami.classList.add("selected");
    const amiText = document.querySelector("#launch-amazon-" + region + " code").innerText;

    updateAwsLaunch(region, amiText);
  }
  setupAwsLaunch();

  // when client changes AWS region
  awsSelection.addEventListener('change', function(event) {

    // remove all AMIs from table
    const allAmis = document.querySelectorAll("[id^=launch-amazon-");
    Array.from(allAmis).forEach((ami) => ami.classList.remove("selected"));

    // add new AMI to table
    const newRegion = this.value;
    const newAmi = document.querySelector("#launch-amazon-" + newRegion);
    newAmi.classList.add("selected");

    const newAmiText = document.querySelector("#launch-amazon-" + newRegion + " code").innerText;

    console.log(newAmi);

    updateAwsLaunch(newRegion, newAmiText);
  });
</script>

<p>
  NixOS can be deployed to Amazon EC2 with a pre-generated AMI image that you can select below.
</p>

<h3 class="text-2xl font-bold text-nixdarkblue">
  Via AWS Management Console
</h3>

<p>
  You can create an instance using the AWS Management Console by selecting the region and clicking the Launch button.
</p>

<div class="launch-amazon [&_tr.selected]:table-row">
  <span class="font-bold text-xl">Choose region: </span>
  <select class="select-region text-xl font-normal bg-white border-solid border-1 border-neutral-500">
    {amis.data.options.map((option) => {
      const selected = (option.region === "ap-east-1")
      return (<option value={option.region} {selected}>{option.region}</option>)
    })}
  </select>
  <table class="bg-nixlighterblue p-[1rem] my-[1rem] border-separate rounded-2xl w-full">
    <thead class="text-lg text-nixlightblue">
      <tr>
        <th>Root storage</th>
        <th>Virtualisation</th>
        <th colspan="2">AMI</th>
      </tr>
    </thead>
    <tbody class="[&>tr]:hidden text-center font-bold text-lg">
      {amis.data.options.map((option) => (
        <tr id={amis.data.idPrefix+option.region}>
          <td>{option.storage}</td>
          <td>{option.storage}</td>
          <td colspan="2"><CodeInline>{option.ami}</CodeInline></td>
        </tr>
      ))}
    </tbody>
  </table>

  <Button
    color="semidarkblue"
    size="sm"
    href="#"
    classList={['launch-aws', 'w-full md:w-auto block md:inline text-center md:text-left']}
  >
    Launch
  </Button>
</div>

<h3 class="text-2xl font-bold text-nixdarkblue">
  Via Command Line
</h3>

<p>
  You can also create an instance from the command line.
  For example, to create an instance in region
  <CodeInline>eu-west-1</CodeInline>
  using the EC2 API tools, just run:
</p>

<CodeBlock lines={[
  {"shellPrompt":"$", "code":" nix-shell -p ec2_api_tools" },
  {"shellPrompt":"(nix-shell) $", "code":" ec2-run-instances ami-0fc7825fe890f87d1 --region eu-west-1 -k my-key-pair" },
]} />

